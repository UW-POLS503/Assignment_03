<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Assignment 03</title>

<script src="index_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="index_files/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="index_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="index_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="index_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="index_files/htmlwidgets-0.6/htmlwidgets.js"></script>
<script src="index_files/datatables-binding-0.1/datatables.js"></script>
<script src="index_files/datatables-1.10.7/jquery.dataTables.min.js"></script>
<link href="index_files/datatables-default-1.10.7/dataTables.extra.css" rel="stylesheet" />
<link href="index_files/datatables-default-1.10.7/jquery.dataTables.min.css" rel="stylesheet" />


<style type="text/css">code{white-space: pre;}</style>
<link rel="stylesheet"
      href="index_files/highlight/default.css"
      type="text/css" />
<script src="index_files/highlight/highlight.js"></script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<div class="container-fluid main-container">

<!-- tabsets -->
<script src="index_files/navigation-1.0/tabsets.js"></script>
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->





$$
\DeclareMathOperator{\E}{E}
\DeclareMathOperator{\mean}{mean}
\DeclareMathOperator{\Var}{Var}
\DeclareMathOperator{\Cov}{Cov}
\DeclareMathOperator{\Cor}{Cor}
\DeclareMathOperator{\Bias}{Bias}
\DeclareMathOperator{\MSE}{MSE}
\DeclareMathOperator{\sd}{sd}
\DeclareMathOperator{\se}{se}
\DeclareMathOperator{\rank}{rank}
\DeclareMathOperator*{\argmin}{arg\,min}
\DeclareMathOperator*{\argmax}{arg\,max}

\newcommand{\mat}[1]{\boldsymbol{#1}}
\newcommand{\vec}[1]{\boldsymbol{#1}}
\newcommand{\T}{'}

\newcommand{\distr}[1]{\mathcal{#1}}
\newcommand{\dnorm}{\distr{N}}
\newcommand{\dmvnorm}[1]{\distr{N}_{#1}}
$$

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Assignment 03</h1>

</div>


<p>Instructions</p>
<ol style="list-style-type: decimal">
<li><a href="https://help.github.com/articles/using-pull-requests/">Fork this repository</a> to your GitHub account.</li>
<li>Write your solutions in R Markdown in a file named <code>solutions.Rmd</code>.</li>
<li>When you are ready to submit your assignment, <a href="https://help.github.com/articles/using-pull-requests/#initiating-the-pull-request">initiate a pull request</a>. Title your pull request “Submission”.</li>
</ol>
<p>To update your fork from the upstream repository:</p>
<ol style="list-style-type: decimal">
<li>On your fork, e.g. <code>https://github.com/jrnold/Assignment_03</code> click on “New Pull request”</li>
<li>Set your fork <code>jrnold/Assignment_03</code> as the base fork on the left, and <code>UW-POLS503/Assignment_03</code> as the head fork on the right. In both cases the branch will be master. This means, compare any canes in the head fork that are not in the base fork. You will see differences between the <code>US-POLS503</code> repository and your fork. Click on “Create Pull Request”, and if there are no issues, “Click Merge” A quick way is to use this link, but change the <code>jrnold</code> to your own username: <code>https://github.com/jrnold/Assignment_03/compare/master...UW-POLS503:master</code>.</li>
</ol>
<p>We’ll use these packages,</p>
<pre class="r"><code>library(&quot;foreign&quot;)
library(&quot;dplyr&quot;)
library(&quot;broom&quot;)
library(&quot;tidyr&quot;)
library(&quot;ggplot2&quot;)
library(&quot;viridis&quot;)
library(&quot;stringr&quot;)
library(&quot;DT&quot;)</code></pre>
<p>Since we are going to do some simulation, we should set a seed, so the results are exactly replicable.</p>
<pre class="r"><code>set.seed(1234)</code></pre>
<p>Since some of these computations will take time, we can cache the results so that knitr will only run code that has changed.</p>
<pre class="r"><code>knitr::opts_chunk$set(cache = TRUE, autodep = TRUE)</code></pre>
<div id="nunn-and-wantchekon-aer-2011-example" class="section level1">
<h1><span class="header-section-number">1</span> Nunn and Wantchekon AER 2011 example</h1>
<p>Let’s run some regressions from</p>
<blockquote>
<p>Nunn, Nathan and Leonard Wantchekon. 2011. “The Slave Trade and the Origins of Mistrust in Africa.” American Economic Review, 101(7):3221-52. <a href="https://dx.doi.org/10.1257/aer.101.7.3221">doi:10.1257/aer.101.7.3221</a></p>
</blockquote>
<p>The replication data for the is available from its <a href="https://dx.doi.org/10.1257/aer.101.7.3221">AER site</a>, but the main dataset is included in this repository. Since the main dataset is a Stata <code>.dta</code> file load it using the <code>read.dta</code> function and convert it to a <strong>dplyr</strong> <code>tbl</code> so the <code>print</code> function produces nicer output.</p>
<pre class="r"><code>nunn &lt;- read.dta(&quot;Nunn_Wantchekon_AER_2011.dta&quot;) %&gt;% tbl_df()</code></pre>
<p>There are many variables in this data. When <code>read.dta</code> converts a Stata data file the descriptions of the variables end up in an R <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/attributes.html">attribute</a> <code>&quot;var.labels&quot;</code>. Print out the variable labels to get the descriptions of the files<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a></p>
<pre class="r"><code>data_frame(variable = names(nunn), description = attr(nunn, &quot;var.labels&quot;)) %&gt;%
  datatable(class = &#39;cell-border stripe&#39;)</code></pre>
<div id="htmlwidget-1137" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1137">{"x":{"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59"],["respno","ethnicity","murdock_name","isocode","region","district","townvill","location_id","trust_relatives","trust_neighbors","intra_group_trust","inter_group_trust","trust_local_council","ln_export_area","export_area","export_pop","ln_export_pop","age","age2","male","urban_dum","occupation","religion","living_conditions","education","near_dist","distsea","loc_murdock_name","loc_ln_export_area","local_council_performance","council_listen","corrupt_local_council","school_present","electricity_present","piped_water_present","sewage_present","health_clinic_present","district_ethnic_frac","frac_ethnicity_in_district","townvill_nonethnic_mean_exports","district_nonethnic_mean_exports","region_nonethnic_mean_exports","country_nonethnic_mean_exports","murdock_centr_dist_coast","centroid_lat","centroid_long","explorer_contact","railway_contact","dist_Saharan_node","dist_Saharan_line","malaria_ecology","v30","v33","fishing","exports","ln_exports","total_missions_area","ln_init_pop_density","cities_1400_dum"],["Respondent number in Afrobarometer dataset","Ethnicity name: from Afrobarometer q79","Ethnicity name: from Murdock","Country 3 digit iso code","Region: from Afrobarometer","District: from Afrobarometer","Town/village: from Afrobarometer","Unique location-of-repondent identifier - based on isocode region district townv","Trust of relatives: q84a","Trust of neighbors: q84b","Intra-group trust: q84d","Inter-group trust: q84c","Trust of local government council: q55d","Log [(total slave exports: Atlantic + Indian) / area (km^2)","(total slave exports: Atlantic + Indian) / area (km^2)","Exports divided by historic Murdock population","Ln (1+exports/Murdock historic population)","Age: q1","Age squared","Indicator for respondent being male: q101","Indicator for respondent living in urban area","Occupation categories: q95","Religion categories: q91","Living condition categories:q4b","Education categories: Afrobarometer q90","Current distance from coast 1000s kms","Historic distance from coast 1000s kms","Murdock identifier for the current location of the respondent","Slave exports measure based on current location of respondent","Perceived performance of local council: q68c","Does the local council listen: q62b","How much corruption in local council: q56c","Is there a school in the PSU: q116b","Is there electricity in the PSU: q116d","Is there piped water in the PSU: q116e","Is there sewage in the PSU: q116f","Is there a health clinic in the PSU: q116g","District-level ethnic fractionalization","Proportion of ethnic group in district","Avg slave exports of other ethnicities within town/village","Avg slave exports of other ethnicities within district","Avg slave exports of other ethnicities within region","Avg slave exports of other ethnicities within country","Historic distance of ethnicity's centroid from the coast (in kms)","Historic latitude of centroid of ethnic group","Historic longitude of centroid of ethnic group","Indicator for historic contact with European explorer","Indicator variable for historic integration into the colonial railway network","Historic distance of ethnicity's centroid from a centroid (town) in Saharan trad","Historic distance of ethnicity's centroid from a line (route) in Saharan trade (","Ethnic groups average malaria ecology measure","Pre-colonial settlement patterns of ethnicity: from Ethngraphic Atlas v30","Pre-colonial juris. hierarchy beyond the local community: Ethnographic Atlas v33","Pre-colonial reliance on fishing: Ethnographic Atlas v3","(Atlantic+Indian Exports)","ln(1+Atlantic+Indian Exports)","Total Catholic + Protestant mission per land area","Log population density during the colonial period - from Murdock","Indicator for existence of city among ethnic group in 1400"]],"container":"<table class=\"cell-border stripe\">\n  <thead>\n    <tr>\n      <th> \u003c/th>\n      <th>variable\u003c/th>\n      <th>description\u003c/th>\n    \u003c/tr>\n  \u003c/thead>\n\u003c/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]},"callback":null,"filter":"none"},"evals":[],"jsHooks":[]}</script>
<p>In Table 1, NW run several models with Trust in Neighbors as an outcome variable, different measures of slave exports as the treatment variable, and the same set of controls variables. Some of the relevant variables in the data are:</p>
<ul>
<li><code>trust_neighbors</code>: Trust of neighbors</li>
<li><code>exports</code>: Slave exports in 1000s</li>
<li>Individual controls: <code>age</code>, <code>age2</code>, <code>male</code>, <code>urban_dum</code>, <code>education</code>, <code>occupation</code>, <code>religion</code>, <code>living_conditions</code></li>
<li>District controls: <code>district_ethnic_frac</code>, <code>frac_ethnicity_in_district</code></li>
<li>Country-fixed effects: <code>isocode</code></li>
</ul>
<p>Note that NW use <code>education</code>, <code>occupation</code>, <code>religion</code>, and <code>living_conditions</code> as factor variables. Convert them accordingly,</p>
<pre class="r"><code>factor_vars &lt;- c(&quot;education&quot;, &quot;occupation&quot;, &quot;religion&quot;, &quot;living_conditions&quot;)
for (i in factor_vars) {
  nunn[[i]] &lt;- factor(nunn[[i]])
}</code></pre>
<div id="bivariate-regression" class="section level2">
<h2><span class="header-section-number">1.1</span> Bivariate regression</h2>
<p>Run a regression of the Trust of Neighbors on Slave exports. This is Table 1, Model 1, without any of the control variables.</p>
<pre class="r"><code>mod_1_0 &lt;- lm(trust_neighbors ~ exports, data = nunn)</code></pre>
<div class="bs-callout bs-callout-info">
<ul>
<li>Interpret the magnitude and statistical significance of the coefficient on <code>exports</code>.</li>
<li>Plot the fitted values and confidence interval of the fitted values of the regresion.</li>
<li>Plot the residuals of this regression against the fitted values of the regression. Do they appear to have constant variance? Are they approximately symmetric?</li>
<li>What is the null hypothesis of the t-test reported by <code>summary()</code>? Explain the meaning of the p-value. Be precise. Is the p-value the probability that the null hypothesis is correct?</li>
</ul>
</div>
<div class="bs-callout bs-callout-warning">
<p>An increase of thousand slave exports from an ethnic group is associated with an expected -510^{-4} decrease in trust in neighbors on a scale of 0–3. This effect is statistically significant (<span class="math inline">\(p &lt; -.001\)</span>).</p>
<pre class="r"><code>summary(mod_1_0)</code></pre>
<pre><code>## 
## Call:
## lm(formula = trust_neighbors ~ exports, data = nunn)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -1.7891 -0.7889  0.2109  1.2109  1.6761 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  1.789e+00  7.719e-03  231.77   &lt;2e-16 ***
## exports     -5.441e-04  3.343e-05  -16.28   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 1.003 on 20578 degrees of freedom
##   (1242 observations deleted due to missingness)
## Multiple R-squared:  0.01271,    Adjusted R-squared:  0.01267 
## F-statistic:   265 on 1 and 20578 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>In order to plot the fitted values against the scatterplot, I use <code>broom::augment()</code> with a <code>newdata</code> argument to calculate predicted values for each value of <code>exports</code> from the minimum to the maximum.</p>
<pre class="r"><code>mod_1_0_fitted &lt;-
  augment(mod_1_0,
          newdata = data_frame(exports = seq(min(nunn$exports, na.rm = TRUE),
                                             max(nunn$exports, na.rm = TRUE),
                                             length.out = 100)))</code></pre>
<p>Now I plot the predicted values of the regression, the 95% confidence interval, and the original data. Since there are over 20,000 observations that only take a few values of <code>trust_neighbors</code>, a scatter plot will not work well since there will be a lot of overplotting. There are several options to deal with this (alpha, jittering), but for this example I will use hexagon binning; which is like a 2D histogram. I also use the <a href="https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html">viridis</a> color scale.</p>
<pre class="r"><code>ggplot() +
  geom_line(data = mod_1_0_fitted,
                     mapping = aes(x = exports, y = .fitted)) +
  geom_ribbon(data = mod_1_0_fitted,
              mapping = aes(x = exports, y = .fitted,
                            ymin = .fitted - 2 * .se.fit,
                            ymax = .fitted + 2 * .se.fit),
              alpha = 0.3) +
  geom_hex(data = na.omit(select(nunn, exports, trust_neighbors)),
             aes(x = exports, y = trust_neighbors)) +
  ylab(&quot;Trust in Neighbors&quot;) +
  xlab(&quot;Slave exports (thousands)&quot;) + 
  scale_fill_viridis(direction = -1, option = &quot;inferno&quot;) +
  theme_minimal()</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" alt="" /><!-- --></p>
<p>The first noticeable thing about the residuals is that they are arranged in lines; this is a result of the discrete values that the outcome variable takes.</p>
<pre class="r"><code>ggplot(augment(mod_1_0), aes(x = .fitted, y = .std.resid)) +
  geom_point() + 
  ylab(&quot;Studentized residuals&quot;) +
  xlab(expression(hat(y))) +
  theme_minimal()</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-10-1.png" alt="" /><!-- --> Since the outcome variable is bounded at 0 and 3, the residuals are not symmetric. However, since the fitted values only cover a range between 1 and 2, these asymmetry is not too great. Although we are using an OLS regression for a discrete and bounded outcome variable, this does not appear to be too big of an issue.</p>
<p>The null hypothesis of the t-test reported by <code>summary.lm()</code> is <span class="math inline">\(\beta_{\mathtt{exports}} = 0\)</span>. The <span class="math inline">\(p\)</span>-value is the probability of observing a <span class="math inline">\(t\)</span>-statistic equal to or more extreme than what was observed in the sample under repeated samples drawn from the same population, if the null hypothesis were true. No, the <span class="math inline">\(p\)</span>-value is not the probability that the null hypothesis is correct. In Frequentist statistics, only samples have probabilities, hypotheses do not have a probability associated with them. They are either true of false, but the truth value is unknown. Even in Bayesian inference, the <span class="math inline">\(p\)</span>-value gives the probability of the data given the hypothesis, and to calculate the probability of the hypothesis given the data we would need the prior probability of the null hypothesis.</p>
</div>
</div>
<div id="probablities-of-hypotheses" class="section level2">
<h2><span class="header-section-number">1.2</span> Probablities of Hypotheses</h2>
<p>Frequentist statistics assigns no probabilities to hypotheses (parameter values). They are either true or false, but they are unknown. Only samples are random variables, and have an associated probability. But as scientists, we are generally interested in the probability that a hypothesis is correct.<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a> The probability that the research hypothesis (<span class="math inline">\(H_0\)</span>) is correct can be calculated with Bayes law, <span class="math display">\[
p(H_0 | \text{data}) =
\frac{p(\text{data} | H_0) p(H_0)}{p(\text{data} | H_a) p(H_a) + p(\text{data} | H_0) p(H_0)} = \frac{p(\text{data} | H_0) p(H_0)}{p(\text{data})}
\]</span> Working somewhat informally, the p-value gives <span class="math inline">\(p(\text{data} | H_0)\)</span>. An important missing piece of information is the baseline or prior probability that the null hypothesis is true, <span class="math inline">\(p(H_0)\)</span>, which is the complement of the probability that the research hypothesis is true, <span class="math inline">\(p(H_0) = 1 - p(H_a)\)</span>,<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a> <a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a></p>
<div class="bs-callout bs-callout-info">
<ul>
<li>If more than the p-value is required to make sense of the research findings, what does the article do to increase your belief about the research hypothesis, <span class="math inline">\(p(H_a)\)</span>?</li>
<li>Suppose you believed that NW were p-value hacking (which I don’t think they are!). What part of Bayes law is that affecting? If you think that someone is p-value hacking, then you are saying that they will always produce significant p-values regardless of whether the null or alternative hypotheses are true.</li>
</ul>
</div>
<div class="bs-callout bs-callout-warning">
<p>Anything in the article which increases the plausibility of their theory, e.g. prior literature and the mechanisms of their theory, increases the prior probability of the research hypothesis, <span class="math inline">\(p(H_a)\)</span>. This is the difference between this paper, and a paper which tests ESP.</p>
<p>P-value hacking makes is so that the probability of the observing the data in the paper does not depend on the truth of the hypothesis which would generate these data. In other words the probability of observing a statistically significant result is 1, <span class="math inline">\(p(\text{data}) = 1\)</span>. This means that a p-hacked paper should have no affect on our beliefs about a hypothesis since there is no relationship between the data observed and the truth of the hypotheses.</p>
</div>
</div>
<div id="multiple-regression" class="section level2">
<h2><span class="header-section-number">1.3</span> Multiple regression</h2>
<p>In the models in Table 1, NW includes control variables to account for individual, district, and country-level variables that may explain differences.</p>
<p>Run the model in Table 1, Model 1:</p>
<pre class="r"><code>mod_1_1 &lt;- lm(trust_neighbors ~
              exports +
              # controls
              # individual level
              age + age2 + male + urban_dum + education +
              occupation + religion + living_conditions +
              # district-level 
              district_ethnic_frac + frac_ethnicity_in_district +
              # country-level
              isocode,
              data = nunn)
tidy(mod_1_1) %&gt;% filter(term == &quot;exports&quot;)</code></pre>
<pre><code>##      term     estimate    std.error statistic      p.value
## 1 exports -0.000679136 4.855134e-05   -13.988 2.986858e-44</code></pre>
<div class="bs-callout bs-callout-info">
<ul>
<li>Interpret the coefficient on <code>exports</code></li>
<li>How much does the coefficient change with the addition of control variables? What does that suggest?</li>
<li>Do the R^2 and number of observations match those reported in Table 1?</li>
<li>Calculate the fitted values of the regression by multiplying the <span class="math inline">\(\beta\)</span> vector and the <span class="math inline">\(\mat{X}\)</span> matrix. Use <code>model.matrix</code> to produce the <span class="math inline">\(X\)</span> matrix, and <code>%*%</code> to multiply matrices. Confirm that you get the same results as using <code>predict()</code>.</li>
<li>How would you create a plot that shows the predicted values of <code>trust_neighbors</code> as the value of <code>exports</code> changes? What is different about the multiple regression case than the bivariate case?</li>
</ul>
</div>
<div class="bs-callout bs-callout-warning">
<p>An increase of one thousand exported slaves is associated with an expected decrease of -710^{-4} in the response to trust in neighbors, controlling for individual, district, and country level differences.</p>
<p>The regression coefficients in the version with and without controls are not too different, -0.0005 vs. -0.00067. Coefficient statibility to the inclusion of control variables is used as a heuristic for the potential importance of OVB. More formally, Nunn and Wantchekon use the method developed in Bellows and Miguel (2009) in the Section &quot; Using Selection on Observables to Assess the Bias from Unobservables&quot; on p. 3237. The statistic itself is simple: <span class="math inline">\(\hat{\beta}_f / (\hat{\beta}_r - \hat{\beta}_f)\)</span> where <span class="math inline">\(\hat{\beta}_f\)</span> is the coefficient from the full regression (including controls), and <span class="math inline">\(\hat{\beta}_r\)</span> is the coefficient from the restricted regession (excluding controls):</p>
<pre><code>```r
beta_f &lt;- coef(mod_1_1)[[&quot;exports&quot;]]
beta_r &lt;- coef(mod_1_0)[[&quot;exports&quot;]]
beta_f / (beta_r - beta_f)
```

```
## [1] -5.030797
```
The interpretation of this is that the covariation between the omitted variables and slave exports would have to be five times larger than the covariation between slave exports and the controls included in this regression. </code></pre>
<p>The <span class="math inline">\(R^2\)</span> and number of observations match those reported in the table.</p>
<pre class="r"><code>round(summary(mod_1_1)$r.squared, 2)</code></pre>
<pre><code>## [1] 0.16</code></pre>
<pre class="r"><code>length(fitted(mod_1_1))</code></pre>
<pre><code>## [1] 20027</code></pre>
<p>I had meant to ask whether the standard errors also match those reported in Table 1, but I moved that to a later question. They do not. The coefficients match, but the standard errors are <strong>much</strong> smaller for the reasons discussed below.</p>
<p>The purpose of asking you to calculate the fitted values manually is so that you understand some of the matrix algebra in You can calculate the design matrix, <span class="math inline">\(X\)</span>, of a regression in R using <code>model.matrix()</code>. This will expand the formula for the regression, e.g. turning factors into dummy variables, and return a numeric matrix.</p>
<pre class="r"><code>X &lt;- model.matrix(mod_1_1)
beta &lt;- coef(mod_1_1)</code></pre>
<p>Now calculate <span class="math display">\[
\hat{y} = X \hat\beta =
\begin{bmatrix}
\hat\beta_0 \cdot 1  + \hat\beta_1 x_{1,1} + \dots + \hat\beta_{K,1} \\
\hat\beta_0 \cdot 1  + \hat\beta_1 x_{1,2} + \dots + \hat\beta_{K,2} \\
\vdots \\
\hat\beta_0 \cdot 1  + \hat\beta_1 x_{1,N} + \dots + \hat\beta_{K,N}
\end{bmatrix}.
\]</span></p>
<pre class="r"><code>yhat &lt;- X %*% beta
head(yhat)</code></pre>
<pre><code>##       [,1]
## 1 1.342690
## 2 1.259782
## 3 1.322990
## 4 1.292238
## 5 1.379541
## 6 1.411596</code></pre>
<p>We can check that these are the fitted values,</p>
<pre class="r"><code>all.equal(fitted(mod_1_1), as.numeric(yhat), check.attributes = FALSE)</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>Note, I use <code>all.equal</code> so that the comparison will allow the two vectors to be nearly equal (something which should always be done with floating point numbers due to rounding error). The argument <code>check.attributes</code> ignores that one vector has names and the other does not, because we only care that they have the same numerical values.</p>
<p>If we were to plot the fitted values against exports in a scatter plot we would have to consider how to handle the control variables. Without control variables we could plot the fitted values of the regresion directly against actual data. Each fitted value has different values of <span class="math inline">\(x\)</span>. One way would be to plot the fitted values at representative values of the control varaibles, e.g. means of numeric variables, and modes of factor variables. Alternatively, we could average over all the control variables. If you are only interested in how well the regresion fits at different values of the outcome variable, plotting the residuals may make more sense.</p>
</div>
<div id="understanding-multiple-regression" class="section level3">
<h3><span class="header-section-number">1.3.1</span> Understanding Multiple Regression</h3>
<div class="bs-callout bs-callout-info">
<ul>
<li>Run the following regressions
<ol style="list-style-type: decimal">
<li><p>Regress regression of <code>trust_neighbors</code> on the controls.</p>
<pre class="r"><code>lm(trust_neighbors ~ age + age2 + male + urban_dum +
   education + occupation + religion + living_conditions +
   district_ethnic_frac + frac_ethnicity_in_district +
   isocode, data = nunn)</code></pre>
<pre><code>## 
## Call:
## lm(formula = trust_neighbors ~ age + age2 + male + urban_dum + 
##     education + occupation + religion + living_conditions + district_ethnic_frac + 
##     frac_ethnicity_in_district + isocode, data = nunn)
## 
## Coefficients:
##                (Intercept)                         age  
##                  1.2782704                   0.0075983  
##                       age2                        male  
##                 -0.0000494                   0.0510032  
##                  urban_dum                  education1  
##                 -0.1594966                   0.0314458  
##                 education2                  education3  
##                 -0.0630473                  -0.1524498  
##                 education4                  education5  
##                 -0.2019640                  -0.2016031  
##                 education6                  education7  
##                 -0.2532422                  -0.3039204  
##                 education8                  education9  
##                 -0.1425985                  -0.2725780  
##                occupation1                 occupation2  
##                  0.0722063                   0.0731181  
##                occupation3                 occupation4  
##                  0.0671592                   0.0017896  
##                occupation5                 occupation6  
##                  0.0755122                  -0.0961679  
##                occupation7                 occupation8  
##                  0.0097435                  -0.0844278  
##                occupation9                occupation10  
##                 -0.1037941                  -0.0384627  
##               occupation11                occupation12  
##                 -0.0526848                  -0.1604573  
##               occupation13                occupation14  
##                 -0.0245484                  -0.0751694  
##               occupation15                occupation16  
##                 -0.2297423                  -0.0190316  
##               occupation18                occupation19  
##                 -0.1800131                  -0.1489991  
##               occupation20                occupation21  
##                 -0.0270935                  -0.0447961  
##               occupation22                occupation23  
##                 -0.1016604                  -0.1085771  
##               occupation24                occupation25  
##                  0.0244322                   0.0074535  
##              occupation995                   religion2  
##                 -0.0097963                   0.0440370  
##                  religion3                   religion4  
##                  0.0687563                   0.0363079  
##                  religion5                   religion6  
##                  0.0258377                  -0.0674540  
##                  religion7                  religion10  
##                  0.0140030                   0.0458754  
##                 religion11                  religion12  
##                  0.2831639                   0.3086493  
##                 religion13                  religion14  
##                 -0.0681065                   0.0398328  
##                 religion15                 religion360  
##                  0.3993899                   0.3862733  
##                religion361                 religion362  
##                  0.3569926                   0.8240821  
##                religion363                 religion995  
##                  0.3506265                   0.0436281  
##         living_conditions2          living_conditions3  
##                  0.0607460                   0.1020260  
##         living_conditions4          living_conditions5  
##                  0.1325637                   0.1290344  
##       district_ethnic_frac  frac_ethnicity_in_district  
##                 -0.0024118                   0.0659809  
##                 isocodeBWA                  isocodeGHA  
##                 -0.0435570                   0.2208941  
##                 isocodeKEN                  isocodeLSO  
##                  0.2128326                  -0.1743453  
##                 isocodeMDG                  isocodeMLI  
##                  0.0415341                   0.3224215  
##                 isocodeMOZ                  isocodeMWI  
##                  0.3998523                   0.6573224  
##                 isocodeNAM                  isocodeNGA  
##                  0.2552472                  -0.0343237  
##                 isocodeSEN                  isocodeTZA  
##                  0.6881418                   0.5813355  
##                 isocodeUGA                  isocodeZAF  
##                  0.3183201                   0.1903093  
##                 isocodeZMB  
##                  0.1647789</code></pre>
Save the residuals.</li>
<li><p>Run the regression of <code>exports</code> on the controls. Save the residuals</p>
<pre class="r"><code>lm(exports ~ age + age2 + male + urban_dum +
   education + occupation + religion + living_conditions +
   district_ethnic_frac + frac_ethnicity_in_district +
   isocode, data = nunn)</code></pre>
<pre><code>## 
## Call:
## lm(formula = exports ~ age + age2 + male + urban_dum + education + 
##     occupation + religion + living_conditions + district_ethnic_frac + 
##     frac_ethnicity_in_district + isocode, data = nunn)
## 
## Coefficients:
##                (Intercept)                         age  
##                  5.268e+02                   4.930e-01  
##                       age2                        male  
##                 -1.232e-03                  -8.449e+00  
##                  urban_dum                  education1  
##                  2.193e+01                  -2.029e+01  
##                 education2                  education3  
##                  1.316e+01                   1.896e+01  
##                 education4                  education5  
##                  1.466e+01                   2.174e+01  
##                 education6                  education7  
##                  1.637e+01                   2.564e+01  
##                 education8                  education9  
##                  4.026e+01                   2.111e+01  
##                occupation1                 occupation2  
##                 -1.099e+01                   1.060e+00  
##                occupation3                 occupation4  
##                 -4.647e+01                   1.212e+01  
##                occupation5                 occupation6  
##                 -9.407e+00                   2.202e+01  
##                occupation7                 occupation8  
##                  8.466e+00                  -1.202e+01  
##                occupation9                occupation10  
##                  3.097e+00                   8.044e+00  
##               occupation11                occupation12  
##                  3.405e+01                   5.352e+00  
##               occupation13                occupation14  
##                  1.027e+01                   2.911e+01  
##               occupation15                occupation16  
##                  8.852e+00                   1.109e+01  
##               occupation18                occupation19  
##                  9.393e+00                  -2.134e+01  
##               occupation20                occupation21  
##                  1.883e+00                  -3.606e+00  
##               occupation22                occupation23  
##                  1.847e-01                   1.650e+01  
##               occupation24                occupation25  
##                 -1.229e+01                   2.250e+01  
##              occupation995                   religion2  
##                  1.806e+01                   1.171e+01  
##                  religion3                   religion4  
##                  1.014e+01                   1.003e+01  
##                  religion5                   religion6  
##                  2.173e+01                   6.620e+01  
##                  religion7                  religion10  
##                 -1.158e+01                   2.063e+01  
##                 religion11                  religion12  
##                 -8.100e+01                  -4.966e+01  
##                 religion13                  religion14  
##                 -2.220e+00                   6.279e+00  
##                 religion15                 religion360  
##                 -1.339e+01                  -2.778e+01  
##                religion361                 religion362  
##                 -1.940e+01                   2.301e+00  
##                religion363                 religion995  
##                  5.226e+01                  -6.394e+00  
##         living_conditions2          living_conditions3  
##                 -2.191e+01                  -1.940e+01  
##         living_conditions4          living_conditions5  
##                 -1.454e+01                  -1.207e+01  
##       district_ethnic_frac  frac_ethnicity_in_district  
##                 -2.092e+01                   4.512e+01  
##                 isocodeBWA                  isocodeGHA  
##                 -5.665e+02                  -2.831e+02  
##                 isocodeKEN                  isocodeLSO  
##                 -5.781e+02                  -5.537e+02  
##                 isocodeMDG                  isocodeMLI  
##                 -5.499e+02                  -3.761e+02  
##                 isocodeMOZ                  isocodeMWI  
##                 -4.699e+02                  -5.187e+02  
##                 isocodeNAM                  isocodeNGA  
##                 -5.783e+02                  -3.052e+02  
##                 isocodeSEN                  isocodeTZA  
##                 -4.525e+02                  -5.523e+02  
##                 isocodeUGA                  isocodeZAF  
##                 -5.656e+02                  -5.908e+02  
##                 isocodeZMB                  isocodeZWE  
##                 -5.660e+02                  -6.162e+02</code></pre>
Save the residuals.</li>
<li>Regress the residuals from 1. on the residuals on 2.</li>
</ol></li>
<li>How does the coefficient from regression 3 compare the the coefficient on <code>exports</code> from the regression in Table 1, Model 1? What does that say about what multiple regression is doing?</li>
</ul>
</div>
</div>
</div>
<div id="validity-of-the-standard-errors" class="section level2">
<h2><span class="header-section-number">1.4</span> Validity of the standard errors</h2>
<p>For OLS standard errors to be unbiased each disturbance must have the same variance, <span class="math inline">\(\Var(\varepsilon_i) = \sigma^2\)</span>, and all disturbances must be uncorrelated, <span class="math inline">\(\Cov(\varepsilon_i, \varepsilon_j) = 0\)</span> if <span class="math inline">\(i \neq j\)</span>.</p>
<div class="bs-callout bs-callout-info">
<ul>
<li>How might that assumption be violated?</li>
<li>Plot the residuals of the regression by district. Do they appear to be uncorrelated? What does that say about the validity of the OLS standard errors?</li>
<li>Do the standard errors match those reported in Table 1 of the article? What sort of standard errors does the article use?</li>
</ul>
</div>
<div class="bs-callout bs-callout-warning">
<p>The answers of individuals in the same country, ethnicity, district, or living in close geographic proximity may be correlated even after controlling for the variables included in these models.</p>
<p>There wasn’t a particularly good way to do this. The idea was to get an intuition that clustered standard errors means that groups have correlated residuals. In this case, it is likely that individuals within ethnicities or districts are correlated.</p>
<pre class="r"><code>ggplot(augment(mod_1_1, data = nunn) %&gt;%
         group_by(ethnicity) %&gt;%
         summarize(err = mean(.std.resid),
                   std.err = mean(.std.resid) / (sd(.std.resid) / sqrt(n())), obs = n()) %&gt;%
         filter(obs &gt; 5),
       aes(x = ethnicity, y = err, ymin = err - 2 * std.err, ymax = err + 2 * std.err)) + geom_pointrange()</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-19-1.png" alt="" /><!-- --></p>
<p>In Table 1 (p. 3232), three types of standard errors are reported</p>
<ol style="list-style-type: decimal">
<li>Clustered by ethnic groups</li>
<li>Clustering within ethnic groups and within districts</li>
<li>Standard erorrs adjusted for two-dimensional spatial autocorrelation.</li>
</ol>
<p>The standard errors reported in Table 1 are much larger than those in the OLS regression that we ran earlier. The reason is that the classical OLS errors do not account for correlation within these clusters. Effectively, by ignoring that correlation we are pretending we have many more observations that we do. See <a href="http://cameron.econ.ucdavis.edu/research/Cameron_Miller_Cluster_Robust_October152013.pdf">A Practitioner’s Guide to Cluster-Robust Inference</a> or the discussion of clustered standard errors in Angrist and Pischke “Mostly Harmless Econometrics”. The easiest way to implement cluster robust errors in R is to use the <a href="https://cran.r-project.org/web/packages/plm/index.html">plm</a> package.</p>
</div>
</div>
<div id="regressions-with-log-slave-exports-per-capita" class="section level2">
<h2><span class="header-section-number">1.5</span> Regressions with log slave exports per capita</h2>
<p>Run the regression in Table 1, model 6, which uses “log(1 + exports / pop)” as a measure of slave exports.</p>
<pre class="r"><code>mod_1_6 &lt;- lm(trust_neighbors ~ ln_export_pop + 
              age + age2 + male + urban_dum + education +
              occupation + religion +
              living_conditions + district_ethnic_frac +
              frac_ethnicity_in_district + isocode,
              data = nunn)  </code></pre>
<div>
<ul>
<li>Interpret the effect of <code>ln_export_pop</code> on <code>trust_neighbors</code></li>
<li>Why is “log(1 + exports / pop)” used as the measure instead of “log(exports / pop)”?</li>
</ul>
</div>
<div class="bs-callout bs-callout-warning">
<p>Roughly, a one percentage point increase in slave exports in an ethnic groups is associated with an expected decrease of 0.0074 (-0.74/100) in the the response for trust in neighbors of members of that ethnicity, controlling for individual, district, and country characteristics.</p>
<p>Many ethnicities have values of zero for slave exports, and <span class="math inline">\(\log(0)\)</span> is undefined. Adding a small positive number is a common way to adjust variables that seem to have a logarithmic (decreasing returns) effect, but include zeros.</p>
<p>The rest of this question was somewhere between poorly worded and incoherent. My intent was to have you plot the functional forms in each regression.</p>
</div>
</div>
<div id="sampling-distribution-of-ols-coefficients" class="section level2">
<h2><span class="header-section-number">1.6</span> Sampling distribution of OLS coefficients</h2>
<p>Let’s understand what the confidence intervals mean in terms of the sampling distribution. Since we don’t know the true parameter values for this, we will pretend that the OLS point estimates from the regression are the “true” population parameters.</p>
<p>The plan to generate a sampling distribution of <span class="math inline">\(\beta\)</span> is:</p>
<ol style="list-style-type: decimal">
<li>Draw a new sample <span class="math inline">\(\tilde{y}_i \sim N(\hat{y}_i, \hat{\sigma}^2)\)</span>.</li>
<li>Estimate OLS estimates <span class="math inline">\(\tilde{\vec{y}} = \tilde{vec{beta}} \mat{X} + \tilde{vec{varepsilon}} = \hat{y} + \tilde{\vec{\varepsilon}}\)</span>.</li>
<li>Repeat steps 1–2, <code>iter</code> times, store <span class="math inline">\(\beta^*\)</span> for each iteration, and return the estimates for all samples.</li>
</ol>
<p>Then, the distribution of the <span class="math inline">\(\beta^*\)</span> is a sampling distribution of the parameters.</p>
<div class="bs-callout bs-callout-info">
<p>Why is only <span class="math inline">\(\vec{y}\)</span> being samples? Why is <span class="math inline">\(\mat{X}\)</span> fixed in these simulations? See Wooldridge Ch 2 and 3 discussion of the assumptions of OLS.</p>
</div>
<div class="bs-callout bs-callout-info">
<p>The standard assumptions for regression assume fixed values of <span class="math inline">\(\mat{X}\)</span>. However, regression will work for random <span class="math inline">\(\mat{X}\)</span> if <span class="math inline">\(\mat{X}\)</span> is uncorrelated with the disturbances <span class="math inline">\(\vec{\varepsilon}\)</span>.</p>
</div>
<p>Let’s take the results of the model on <code>ln_export_pop</code> and explore the sampling distribution of <span class="math inline">\(\beta\)</span> from that model.</p>
<p>First run the model,</p>
<pre class="r"><code>mod &lt;- lm(trust_neighbors ~ ln_export_pop + 
          age + age2 + male + urban_dum + education +
          occupation + religion +
          living_conditions + district_ethnic_frac +
          frac_ethnicity_in_district + isocode,
          data = nunn, na.action = na.exclude)</code></pre>
<p>The argument <code>na.action = na.exclude</code> ensures that when we calculate residuals, etc. they will be padded with missing values so they are the same length as the original <code>nunn</code> data. There are other ways to work around this, but this makes the code to run the simulations easier, especially the step that draws <code>y_hat</code>.</p>
<p>Extract the values of the parameter estimates, <span class="math inline">\(\hat{\beta}\)</span>, the model matrix, <span class="math inline">\(X\)</span>,the regression standard error, <span class="math inline">\(\hat{\sigma}\)</span>, and the number of observations, <span class="math inline">\(N\)</span>.</p>
<pre class="r"><code>y_hat &lt;- predict(mod, na.action = na.exclude)
sigma &lt;- sqrt(sum(residuals(mod) ^ 2, na.rm = TRUE) / mod$df.residual)
n &lt;- nrow(nunn)</code></pre>
<p>Later we’ll also need the original Choose a number of iterations to run. For this example use 1,024.</p>
<pre class="r"><code>iter &lt;- 1024</code></pre>
<p>Create a list to store the results</p>
<pre class="r"><code>results &lt;- vector(mode = &quot;list&quot;, length = iter)</code></pre>
<p>For iterations <code>1 ... iter</code> we cant to</p>
<ul>
<li>Draw the regression errors from i.i.d normal distributions, <span class="math inline">\(\tilde\epsilon_i \sim N(0, \hat\sigma^2)\)</span>.</li>
<li>Generate a new dependent variable, <span class="math inline">\(\tilde{\vec{y}} = \mat{X} \hat{\vec{\beta}} + \tilde{\vec{epsilon}}\)</span>.</li>
<li>Run an OLS regression to estimate the coefficients on the new data, <span class="math inline">\(\tilde{\vec{y}} = \mat{X} \tilde{\vec{\beta}} + \tilde{\vec{\epsilon}}\)</span></li>
<li>Save the <span class="math inline">\(\tilde{\beta}\)</span></li>
</ul>
<pre class="r"><code>p &lt;- progress_estimated(iter, min_time = 2)
for (i in seq_len(iter)) {
  # draw errors
  errors &lt;- rnorm(n, mean = 0, sd = sigma)
  # create new outcome variable from errors
  nunn[[&quot;trust_neighbors_new&quot;]] &lt;- y_hat + errors
  # Replace the dependent variable with the newly sampled y
  newmod &lt;- lm(trust_neighbors_new ~ ln_export_pop + 
            age + age2 + male + urban_dum + education +
            occupation + religion +
            living_conditions + district_ethnic_frac +
            frac_ethnicity_in_district + isocode,
            data = nunn)
  # Formula objects are manipulable in R. So a more general
  # way to do the above is to alter the formula from the model
  # by replacing trust_neighbors ~ ... with trust_neighbors_new ~ ...
  # formula &lt;- formula(mod$terms)
  # formula[[2]] &lt;- &quot;trust_neighbors_imputed&quot;
  # # check that this worked
  # # print(formula)
  # # Also this should be put outside the loop, since it doesn&#39;t
  # # change
  # newmod &lt;- lm(formula, data = nunn)
  # Save the coefficients as a data frame to the list
  results[[i]] &lt;- tidy(newmod) %&gt;% mutate(.iter = i)
  # Progress bar update
  p$tick()$print()
}
# clean up: remove the new variable
nunn[[&quot;trust_neighbors_new&quot;]] &lt;- NULL</code></pre>
<p>Finally, since <code>results</code> is a list of data frames, stack the data frames in the list to form a single data frame that is easier to analyze:</p>
<pre class="r"><code>results &lt;- bind_rows(results)</code></pre>
<p><strong>Note:</strong> this will take a few minutes.</p>
<div class="bs-callout bs-callout-info">
<p>Use the results of this simulation to answer the following questions:</p>
<ul>
<li>Plot the distribution of the coeficient of <code>ln_export_pop</code>.</li>
<li>What is the standard deviation of the sampling distribution of the coefficient of <code>ln_export_pop</code>? How does this compare to the standard error of this coefficient given by <code>lm()</code>?</li>
<li>Calculate the correlation matrix of the coefficients. For the first step will need to create a data frame using <code>spread</code> in which the rows are iterations, the columns are coefficients, and the values are the estimates.</li>
<li>Plot that correlation matrix using <code>geom_raster</code>. Are the coefficients uncorrelated? In general, when would coefficients be more or less correlated?</li>
<li>Why is this simulation not (directly) appropriate for calculating a <span class="math inline">\(p\)</span>-value. What distribution would you have to simulate from to calculate a <span class="math inline">\(p\)</span>-value?</li>
</ul>
</div>
<div class="bs-callout bs-callout-warning">
<p>The sampling distribution of <span class="math inline">\(\hat{\beta}_{\mathtt{ln\_export\_pop}}\)</span> is approximately normal and centered at its OLS value of around -0.75.</p>
<pre class="r"><code>ggplot(filter(results, term == &quot;ln_export_pop&quot;),
       aes(x = estimate)) +
  geom_density() + geom_rug()</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-27-1.png" alt="" /><!-- --></p>
<p>The standard deviation of the estimated sampling distribution of the coefficient of <code>ln_export_pop</code> is</p>
<pre class="r"><code>filter(results, term == &quot;ln_export_pop&quot;) %&gt;%
  magrittr::extract2(&quot;estimate&quot;) %&gt;%
  sd()</code></pre>
<pre><code>## [1] 0.06328606</code></pre>
<p>This is close to the standard standard error reported in the regression,</p>
<pre class="r"><code>filter(tidy(mod), term == &quot;ln_export_pop&quot;)</code></pre>
<pre><code>##            term   estimate  std.error statistic      p.value
## 1 ln_export_pop -0.7434568 0.06460478 -11.50777 1.551239e-30</code></pre>
<p>The bootstrap is generating values assuming that the estimated model is the “true” model. But in order to calculate a p-value you need to generate the sampling distribution assuming that the null hypothesis is true.</p>
<pre class="r"><code>beta_cor &lt;- filter(results,
       term %in% c(&quot;ln_export_pop&quot;, &quot;age&quot;, &quot;age2&quot;, &quot;male&quot;, &quot;urban_dum&quot;) |
         str_detect(term, &quot;education&quot;) |
         str_detect(term, &quot;occupation&quot;) |
         str_detect(term, &quot;living_conditions&quot;) |
         str_detect(term, &quot;religion&quot;)) %&gt;%
  select(term, estimate, .iter) %&gt;%
  rename(iter = .iter) %&gt;%
  spread(term, estimate, -iter) %&gt;%
  select(-iter) %&gt;%
  cor() %&gt;%
  tidy() %&gt;%
  rename(term = .rownames) %&gt;%
  gather(term2, cor, -term)

ggplot(beta_cor, aes(x = term, y = term2, fill = cor)) +
  geom_raster() +
  scale_fill_viridis()</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-30-1.png" alt="" /><!-- --> The <span class="math inline">\(\beta\)</span> coefficients are not uncorrelated. We can also observe this in the estimated variance-covariance matrix from the regression,</p>
<pre class="r"><code>cov2cor(vcov(mod)[1:6, 1:6])</code></pre>
<pre><code>##               (Intercept) ln_export_pop          age         age2
## (Intercept)    1.00000000  -0.296892726 -0.540483926  0.509289743
## ln_export_pop -0.29689273   1.000000000 -0.013298893  0.004992375
## age           -0.54048393  -0.013298893  1.000000000 -0.975296583
## age2           0.50928974   0.004992375 -0.975296583  1.000000000
## male          -0.07803927   0.029867740 -0.001162037 -0.025516600
## urban_dum     -0.05286134  -0.045585417  0.012435687 -0.018532057
##                       male   urban_dum
## (Intercept)   -0.078039269 -0.05286134
## ln_export_pop  0.029867740 -0.04558542
## age           -0.001162037  0.01243569
## age2          -0.025516600 -0.01853206
## male           1.000000000  0.01914562
## urban_dum      0.019145621  1.00000000</code></pre>
</div>
</div>
<div id="non-parametric-bootstrap" class="section level2">
<h2><span class="header-section-number">1.7</span> Non-parametric Bootstrap</h2>
<p>The previous question was an example of parametric bootstrap. It is a parametric bootstrap because you drew data from an assumed model (the OLS model that you estimated).</p>
<p>An alternative is a non-parametric bootstrap. In a non-parametric bootstrap, instead of drawing samples from model, we are going to redraw samples from the sample.</p>
<p>An analogy is that the sample is to the population as the bootstrap is to the sample. We are treating the sample distribution as an estimate of the population distribution and then drawing samples from that estimated population distribution.</p>
<p>To do the bootstrapping we will use the <code>bootstrap</code> function in the <strong>tidyr</strong> package. However, the <a href="https://cran.r-project.org/web/packages/boot/index.html">boot</a> package supports many more advanced methods of bootstrapping.</p>
<p>Let’s start by drawing a single bootstrap replication. It is a sample of the same size as the original data, drawn from the data <em>with replacement</em>.</p>
<pre class="r"><code>nunn_bootstrapped &lt;- bootstrap(nunn, 1)</code></pre>
<p>So, in order to calculate bootstrap standard errors, we will need to draw a sample of To get bootstrap standard errors, we draw <code>B</code> replications, run an regression, and save the estimates.</p>
<pre class="r"><code>mod_bs &lt;- lm(trust_neighbors ~ ln_export_pop, data = nunn)
beta_bs &lt;- 
  bootstrap(nunn, 1024) %&gt;%
    do(tidy(lm(trust_neighbors ~ ln_export_pop, data = .)))</code></pre>
<p>There are several ways to calculate standard errors from the bootstrap replications. The following are two simple methods.</p>
<ol style="list-style-type: decimal">
<li><p>Calculate the standard error from these simulations by taking the standard deviation of the estimates. Suppose <span class="math inline">\(\beta^{*b}_k\)</span> is the estimated coefficient from replication <span class="math inline">\(b \in 1:B\)</span>, and <span class="math inline">\(\bar\beta^{*}_k = (\sum \beta^{*b}_k) / B\)</span>. Then the bootstrap standard error is, <span class="math display">\[
   \se_k(\hat\beta_{k}) = \sqrt{\frac{1}{B - 1} \sum (\beta^{*b}_k - \bar\beta^{*b}_k)^2}
   \]</span> The confidence interval is thus, <span class="math display">\[
   \hat{\beta}_k \pm \se_{bs}(\hat\beta_k)
   \]</span> Note that you use the estimate <span class="math inline">\(\hat{\beta}_k\)</span> from the original model, not the mean of the bootstrap estimates. This method works well if the sampling distribution of <span class="math inline">\(\beta_k\)</span> is symmetric.</p></li>
<li><p>The second method is to use the quantiles of the bootstrap estimates. E.g. a 95% confidence interval uses the 2.5% and 97.5% quantiles of the bootstrap estimates. This method allows for asymmetric confidence intervals. However, it takes more replications to get accurate values of extreme quantiles than it does to calculate a standard deviation.</p></li>
</ol>
<div class="bs-callout bs-callout-info">
<ul>
<li>Estimate the bootstrapped confidence intervals using those two methods.</li>
<li>Compare the bootstrapped confidence intervals to the OLS confidence interval.</li>
</ul>
</div>
<div class="bs-callout bs-callout-warning">
<p>The confidence interval using the bootstrap standard errors is,</p>
<pre class="r"><code># OLS estimate
betahat &lt;- coef(mod_bs)[[&quot;ln_export_pop&quot;]]
z &lt;- 1.96
filter(beta_bs, term == &quot;ln_export_pop&quot;) %&gt;%
  ungroup() %&gt;%
  summarize(se = sd(estimate)) %&gt;%
  mutate(conf.low = betahat - z * se,
         conf.high = betahat + z * se)</code></pre>
<pre><code>## Source: local data frame [1 x 3]
## 
##           se   conf.low  conf.high
##        (dbl)      (dbl)      (dbl)
## 1 0.04459353 -0.4833508 -0.3085442</code></pre>
<p>The confidence interval using bootstrap quantiles is,</p>
<pre class="r"><code># OLS estimate
filter(beta_bs, term == &quot;ln_export_pop&quot;) %&gt;%
  ungroup() %&gt;%
  summarize(conf.low = quantile(estimate, 0.025),
            conf.high = quantile(estimate, 0.975))</code></pre>
<pre><code>## Source: local data frame [1 x 2]
## 
##     conf.low  conf.high
##        (dbl)      (dbl)
## 1 -0.4772805 -0.3139828</code></pre>
<p>In this case the two methods produce similar confidence intervals, since the sampling distribution of <span class="math inline">\(\hat\beta\)</span> is symmetric. These confidence interval are also similar to those produced by OLS.</p>
<pre class="r"><code>confint(mod_bs)</code></pre>
<pre><code>##                    2.5 %     97.5 %
## (Intercept)    1.7619152  1.7949429
## ln_export_pop -0.4825835 -0.3093115</code></pre>
<p>This is somewhat disappointing. Bootstrapping in this manner does not help us produce confidence intervals accounting for the clustering that produces larger standard errors. The reason is that we are sampling from the “population”. In order to account for the correlation within clusters, we would need to account for the way that the sample was generated from the population. There are several ways to bootstrap with clustering. The most important part is to randomly sample ethnicities from the set of ethnicities.</p>
</div>
<p>There are even more advanced methods such as the studentized bootstrap, and the adjusted bootstrap percentile (BCa) methods included in <code>boot.ci</code>.</p>
<p>For bootstrapped standard errors to be valid, the samples from the data need to be taken in the same way as the sample was taken from the population. For example, in a time series it would be inappropriate to sample observations without accounting for their order.</p>
<div class="bs-callout bs-callout-info">
<ul>
<li>What is the population in this paper?</li>
<li>How was the sample drawn from this population?</li>
<li>In the previous examples, did we draw the sample in the same way as it was drawn from the population? What would be a better way of drawing the bootstrapped samples? Try to implement it; see the <code>group_by</code> argument of <code>bootstrap</code>.</li>
</ul>
</div>
<div class="bs-callout bs-callout-warning">
<p>See above.</p>
<p>The instructions given were too simplistic, and this requires more complicated code than I thought when writing it. The <code>group_by</code> argument for <code>bootstrap()</code> allows for sampling within the clusters, but we need to sample the clusters themselves.</p>
<pre class="r"><code>ethnicities &lt;- select(nunn, ethnicity) %&gt;% unique()
iter &lt;- 1024
bs_samples &lt;- list()
for (i in seq_len(iter)) {
  # Resample ethnic groups
  ethnic_sample &lt;- sample_frac(ethnicities, 1, replace = TRUE)
  # Merge with Nunn data to get a new dataset
  newdata &lt;- left_join(ethnic_sample, nunn, by = &quot;ethnicity&quot;)
  bs_samples[[i]] &lt;- tidy(lm(trust_neighbors ~ ln_export_pop, data = newdata))
}
bs_samples &lt;- bind_rows(bs_samples)

bs_samples %&gt;%
  filter(term == &quot;ln_export_pop&quot;)  %&gt;%
  ungroup() %&gt;%
  summarize(conf.low = quantile(estimate, 0.025),
            conf.high = quantile(estimate, 0.975),
            se = sd(estimate))</code></pre>
<pre><code>## Source: local data frame [1 x 3]
## 
##    conf.low conf.high        se
##       (dbl)     (dbl)     (dbl)
## 1 -0.807128 0.3850288 0.3199544</code></pre>
<p>Now the confidence interval and standard errors are <strong>much</strong> larger than those reported by OLS, and the bootstrapping that did not account for clusters.</p>
</div>
</div>
<div id="f-test-example" class="section level2">
<h2><span class="header-section-number">1.8</span> F-test example</h2>
<p>An <span class="math inline">\(F\)</span>-test tests the null hypothesis that several coefficients in the regression are all 0 vs. the alternative that at least one of the coefficients is non-zero. Suppose you want to test that the <span class="math inline">\(q\)</span> coefficients <span class="math inline">\(\beta_j\)</span> through <span class="math inline">\(\beta_{j + q}\)</span> are all 0, <span class="math display">\[
\begin{aligned}[t]
H_0: &amp;\quad \beta_j = \dots = \beta_J = 0
H_a: &amp;\quad \text{at least one $\beta_k \neq 0$}
\end{aligned}
\]</span></p>
<p>To run an F-test in R, use the <code>anova()</code> function to compare two models. For example, to compare the regression of <code>trust_neighbors</code> on <code>exports</code> without controls to the regression with controls, use</p>
<pre class="r"><code>mod_1_0 &lt;- lm(trust_neighbors ~ ln_export_pop, data = nunn)
mod_1_1 &lt;- lm(trust_neighbors ~ ln_export_pop + age + age2 + male + urban_dum +
              education + occupation + religion + living_conditions +
              district_ethnic_frac + frac_ethnicity_in_district +
              isocode, data = nunn)
anova(mod_1_0, mod_1_1)</code></pre>
<pre><code>## Error in anova.lmlist(object, ...): models were not all fitted to the same size of dataset</code></pre>
<p>We can’t do it! At least not yet. The problem is that <code>lm()</code> drops all rows with at least one missing value. So <code>mod_1_0</code> and <code>mod_1_1</code> run a regression on datasets with different numbers of observations,</p>
<pre class="r"><code>mod_1_0$df.residual + length(mod_1_0$coefficients)</code></pre>
<pre><code>## [1] 18112</code></pre>
<pre class="r"><code>mod_1_1$df.residual + length(mod_1_1$coefficients)</code></pre>
<pre><code>## [1] 17644</code></pre>
<p>The residual degrees of freedom is <span class="math inline">\(N - K - 1\)</span>, and the length of the coefficient vector is <span class="math inline">\(K + 1\)</span>, so their sum is the number of observations in the regression, <span class="math inline">\((N - K - 1) + (K + 1) = N\)</span>.</p>
<p>To ensure that these models are run on the same set of data, create a subset of the <code>nunn</code> data that has all the variables in the larger model, and drop an observations with missing values in any of those variables, using <code>na.omit()</code>.</p>
<pre class="r"><code>nunn_nomiss &lt;- nunn %&gt;%
  select(trust_neighbors, ln_export_pop, age, age2, male, urban_dum,
         education, occupation, religion, living_conditions,
         district_ethnic_frac, frac_ethnicity_in_district,
         isocode) %&gt;%
  na.omit()</code></pre>
<p>Now, we can compare the models,</p>
<pre class="r"><code>mod_1_0 &lt;- lm(trust_neighbors ~ ln_export_pop, data = nunn_nomiss)
mod_1_1 &lt;- lm(trust_neighbors ~ ln_export_pop + age + age2 + male + urban_dum +
              education + occupation + religion + living_conditions +
              district_ethnic_frac + frac_ethnicity_in_district +
              isocode, data = nunn_nomiss)
anova(mod_1_0, mod_1_1)</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Model 1: trust_neighbors ~ ln_export_pop
## Model 2: trust_neighbors ~ ln_export_pop + age + age2 + male + urban_dum + 
##     education + occupation + religion + living_conditions + district_ethnic_frac + 
##     frac_ethnicity_in_district + isocode
##   Res.Df   RSS Df Sum of Sq      F    Pr(&gt;F)    
## 1  17642 17251                                  
## 2  17566 14777 76    2473.7 38.693 &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>The p-value for the F-test is approximately 0, so the test rejects the null hypothesis that all the control variables are equal to 0 at all commonly used levels of significance.</p>
<div class="bs-callout bs-callout-info">
<ul>
<li>Run and interpret an F-test for a reasonable subset of coefficients.</li>
<li>Why can’t you use F-tests to compare different models in Table 1?</li>
<li><p>Run an F-test comparing the model with only controls to the one in Model 1, Table 6. In other words, the null hypothesis is <span class="math inline">\(\beta_{\mathtt{ln\_exports\_pop}} = 0\)</span>.</p>
<pre class="r"><code>mod_controls &lt;- lm(trust_neighbors ~ age + age2 + male + urban_dum +
          education + occupation + religion + living_conditions +
          district_ethnic_frac + frac_ethnicity_in_district +
          isocode,
          data = select(nunn, trust_neighbors, age, age2,
                        male, urban_dum, education, occupation, religion, living_conditions, district_ethnic_frac,
                        frac_ethnicity_in_district, isocode,
                        ln_export_pop) %&gt;% na.omit())
mod_1_6 &lt;- lm(trust_neighbors ~ ln_export_pop + age + age2 + male + urban_dum +
          education + occupation + religion + living_conditions +
          district_ethnic_frac + frac_ethnicity_in_district +
          isocode, data = nunn)</code></pre>
How does the <span class="math inline">\(p\)</span>-value of the F-test compare to the p-value of the regression coefficient on <code>ln_export_pop</code>? Square the t-statistic for the coefficient of <code>ln_export_pop</code>; how does it compare to the F-statistic? What is the relationship between a t-test and an F-test for a single parameter in a regression?</li>
</ul>
</div>
<div class="bs-callout bs-callout-warning">
<p>F-tests can only compare nested models on the same data. The models in Table 1 are not nested, because they are not subsets of each other. Each model uses a different measure of slave exports. The <span class="math inline">\(p\)</span>-value of the test of a single coefficient and the equivalent <span class="math inline">\(F\)</span>-test are the same. The <span class="math inline">\(F\)</span>-statistic is the square of the p-value.</p>
<pre class="r"><code>anova(mod_controls, mod_1_6)</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Model 1: trust_neighbors ~ age + age2 + male + urban_dum + education + 
##     occupation + religion + living_conditions + district_ethnic_frac + 
##     frac_ethnicity_in_district + isocode
## Model 2: trust_neighbors ~ ln_export_pop + age + age2 + male + urban_dum + 
##     education + occupation + religion + living_conditions + district_ethnic_frac + 
##     frac_ethnicity_in_district + isocode
##   Res.Df   RSS Df Sum of Sq      F    Pr(&gt;F)    
## 1  17567 14888                                  
## 2  17566 14777  1     111.4 132.43 &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<pre class="r"><code>tvalue &lt;- tidy(mod_1_6) %&gt;% filter(term == &quot;ln_export_pop&quot;) %&gt;%
  magrittr::extract2(&quot;statistic&quot;)
tvalue</code></pre>
<pre><code>## [1] -11.50777</code></pre>
<pre class="r"><code>tvalue ^ 2 </code></pre>
<pre><code>## [1] 132.4287</code></pre>
</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>This uses the <a href="https://rstudio.github.io/DT/">DT</a> package to produce pretty interactive tables in the HTML.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>See the discussion in (Scientific method: Statistical errors)[<a href="http://www.nature.com/news/scientific-method-statistical-errors-1.14700" class="uri">http://www.nature.com/news/scientific-method-statistical-errors-1.14700</a>], <em>Nature</em>.<a href="#fnref2">↩</a></p></li>
<li id="fn3"><p>Assuming, for simplicity, that <span class="math inline">\(H_0\)</span> and <span class="math inline">\(H_a\)</span> are the only hypotheses so that <span class="math inline">\(p(H_0) + p(H_a) = 1\)</span>.<a href="#fnref3">↩</a></p></li>
<li id="fn4"><p>This question is non-standard and idiosyncratic to the way I interpret research. Additionally, this analysis is heuristic and not intended to be a formal Bayesian hypothesis test.<a href="#fnref4">↩</a></p></li>
</ol>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
